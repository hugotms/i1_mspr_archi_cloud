---

- name: check for cluster availability
  ansible.builtin.command: kubectl cluster-info
  register: result
  until: result.stdout.find("is running at") != -1
  retries: 12
  delay: 10
  changed_when: False

- name: join cluster command
  ansible.builtin.command: kubeadm token create --print-join-command
  register: run_join_command
  tags: definitive
  become: True

- name: save command in temporary file
  ansible.builtin.lineinfile:
    path: "/tmp/{{ client_id | lower }}.sh"
    line: "{{ run_join_command.stdout }}"
    create: True
  delegate_to: localhost
  tags: definitive
  become: True