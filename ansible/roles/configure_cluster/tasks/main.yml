---

- name: initialize kubernetes cluster
  ansible.builtin.shell: >-
    kubeadm init --apiserver-advertise-address={{ ansible_host }} \
    --apiserver-cert-extra-sans={{ ansible_host }}  \
    --node-name {{ inventory_hostname | lower }} \
    --pod-network-cidr=172.16.0.0/16
  args:
    executable: /bin/bash
  when: cloud_function == "master"
  tags:
    - cluster
    - init
    - definitive
  become: True

- name: create svcansible kubernetes config folder on master
  ansible.builtin.file:
    path: /home/svcansible/.kube
    state: directory
  when: cloud_function == "master"
  tags: cluster

- name: copy kubernetes admin config in svcansible config folder
  ansible.builtin.copy:
    remote_src: True
    src: /etc/kubernetes/admin.conf
    dest: /home/svcansible/.kube/config
    owner: svcansible
    group: ansible
  when: cloud_function == "master"
  tags: cluster
  become: True

- name: wait for cluster availability
  ansible.builtin.command: kubectl cluster-info
  register: result
  until: result.stdout.find("is running at") != -1
  retries: 12
  delay: 10
  when: cloud_function == "master"
  changed_when: False
  tags: cluster

- name: get calico manifest
  ansible.builtin.get_url:
    url: "https://raw.githubusercontent.com/projectcalico/calico/{{ calico_version }}/manifests/calico.yaml"
    dest: /tmp
  when: cloud_function == "master"
  tags: cluster

- name: install calico network
  ansible.builtin.shell: >-
    sed -i "s/192.168./172.16./g" /tmp/calico.yaml \
    && kubectl apply -f /tmp/calico.yaml
  args:
    executable: /bin/bash
  when: cloud_function == "master"
  tags:
    - cluster
    - network

- name: removing calico configuration file
  ansible.builtin.file:
    path: /tmp/calico.yaml
    state: absent
  when: cloud_function == "master"
  tags: cluster

- name: join cluster command
  ansible.builtin.shell: kubeadm token create --print-join-command
  args:
    executable: /bin/bash
  register: run_join_command
  when: cloud_function == "master"
  tags:
    - cluster
    - join
    - definitive
  become: True

- name: save command in temporary file
  ansible.builtin.lineinfile:
    path: "/tmp/{{ client_id | lower }}.sh"
    line: "{{ run_join_command.stdout }}"
    create: True
  delegate_to: localhost
  when: cloud_function == "master"
  tags:
    - cluster
    - join
    - definitive
  become: True

- name: copy join command on workers
  ansible.builtin.copy:
    src: "/tmp/{{ client_id | lower }}.sh"
    dest: /tmp/join_command.sh
  when: cloud_function == "worker"
  tags:
    - cluster
    - join
    - definitive
  become: True

- name: append hostname to script
  ansible.builtin.shell: "sed -i '/kubeadm/ s/$/ --node-name {{ inventory_hostname | lower }}/' /tmp/join_command.sh"
  args:
    executable: /bin/bash
  when: cloud_function == "worker"
  tags:
    - cluster
    - join
    - definitive
  become: True

- name: remove command file on localhost
  ansible.builtin.file:
    path: "/tmp/{{ client_id | lower }}.sh"
    state: absent
  delegate_to: localhost
  when: cloud_function == "master"
  tags: worker
  become: True

- name: launch joining command on workers
  ansible.builtin.shell: bash /tmp/join_command.sh
  args:
    executable: /bin/bash
  when: cloud_function == "worker"
  tags:
    - worker
    - join
    - definitive
  become: True

- name: remove command file on workers
  ansible.builtin.file:
    path: /tmp/join_command.sh
    state: absent
  when: cloud_function == "worker"
  tags: worker
  become: True
